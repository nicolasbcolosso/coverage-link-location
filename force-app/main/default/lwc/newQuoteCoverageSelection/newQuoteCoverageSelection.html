<template>
  <div class="new-quote-coverage-selection-container">
    <!-- Header -->
    <header class="slds-modal__header slds-p-around_medium slds-theme_shade">
      <h2 class="slds-text-heading_medium slds-text-color_default">
        <lightning-icon
          icon-name="standard:entitlement"
          size="small"
          class="slds-m-right_x-small"
        ></lightning-icon>
        Select Coverages
      </h2>
    </header>

    <!-- Loading Spinner -->
    <template lwc:if={isLoading}>
      <div class="slds-is-relative exampleHolder">
        <lightning-spinner
          alternative-text="Loading"
          size="medium"
        ></lightning-spinner>
      </div>
    </template>

    <!-- Saving Spinner -->
    <template lwc:elseif={loadSpinner}>
      <div class="slds-is-relative exampleHolder">
        <lightning-spinner
          alternative-text="Saving"
          size="medium"
        ></lightning-spinner>
      </div>
    </template>

    <template lwc:else>
      <!-- Selection Step -->
      <template lwc:if={isSelectionStep}>
        <!-- Footer Actions - Selection -->
        <div class="slds-p-around_medium">
          <div class="slds-grid slds-grid_align-center">
            <lightning-button
              variant="neutral"
              label="Back"
              onclick={handleBack}
              class="slds-m-right_small"
            ></lightning-button>
            <lightning-button
              variant="neutral"
              label="Cancel"
              onclick={handleCancel}
              class="slds-m-right_small"
            ></lightning-button>
            <lightning-button
              variant="brand"
              label="Next"
              onclick={handleNext}
              disabled={canNotProceedToConfiguration}
            ></lightning-button>
          </div>
        </div>

        <div class="slds-p-around_medium">
          <!-- Property Location Warning -->
          <template lwc:if={showPropertyLocationWarning}>
            <div
              class="slds-scoped-notification slds-media slds-media_center slds-theme_warning slds-m-bottom_medium"
              role="alert"
            >
              <lightning-icon
                icon-name="utility:warning"
                alternative-text="Warning"
                variant="warning"
                size="small"
                class="slds-m-right_x-small"
              ></lightning-icon>
              <span class="slds-text-body_regular">
                To add Property coverage, please first add at least one Location
                to the Account.
              </span>
            </div>
          </template>

          <!-- Search Box -->
          <div class="slds-m-bottom_medium">
            <lightning-input
              type="search"
              label="Search Coverages"
              placeholder="Type to search..."
              value={searchTerm}
              onchange={handleSearchChange}
            ></lightning-input>
          </div>

          <!-- Coverage Selection Summary -->
          <div class="slds-m-bottom_medium">
            <span class="slds-badge slds-badge_inverse">
              {selectedCoverageCount} coverage(s) selected
            </span>
          </div>

          <!-- Coverage List -->
          <div class="coverage-list-container">
            <table
              class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped"
            >
              <thead>
                <tr class="slds-line-height_reset">
                  <th scope="col" style="width: 50px">
                    <span class="slds-assistive-text">Select</span>
                  </th>
                  <th scope="col">
                    <div class="slds-truncate" title="Coverage Name">
                      Coverage Name
                    </div>
                  </th>
                  <th scope="col" lwc:if={isLocationBasedPropertyEnabled}>
                    <div class="slds-truncate" title="Info">Info</div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <template for:each={filteredCoverages} for:item="coverage">
                  <tr key={coverage.id} class="slds-hint-parent">
                    <td data-label="Select">
                      <lightning-input
                        type="checkbox"
                        data-coverage-name={coverage.name}
                        checked={coverage.isSelected}
                        onchange={handleCoverageToggle}
                        variant="label-hidden"
                        label="Select"
                      ></lightning-input>
                    </td>
                    <td data-label="Coverage Name">
                      <div class="slds-truncate" title={coverage.name}>
                        {coverage.name}
                      </div>
                    </td>
                    <td
                      data-label="Info"
                      lwc:if={isLocationBasedPropertyEnabled}
                    >
                      <template lwc:if={coverage.isProperty}>
                        <span class="slds-badge slds-badge_lightest">
                          {locationCount} location(s)
                        </span>
                      </template>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </template>

      <!-- Configuration Step -->
      <template lwc:if={isConfigurationStep}>
        <!-- Footer Actions - Configuration -->
        <div class="slds-p-around_medium">
          <div class="slds-grid slds-grid_align-center">
            <lightning-button
              variant="neutral"
              label="Back"
              onclick={handleBack}
              class="slds-m-right_small"
            ></lightning-button>
            <lightning-button
              variant="neutral"
              label="Cancel"
              onclick={handleCancel}
              class="slds-m-right_small"
            ></lightning-button>
            <lightning-button
              variant="brand"
              label="Save"
              onclick={handleSaveNewQuote}
            ></lightning-button>
          </div>
        </div>

        <div class="slds-p-around_medium">
          <!-- Regular Coverages Configuration -->
          <template
            for:each={selectedCoveragesForConfiguration}
            for:item="coverage"
          >
            <lightning-card key={coverage.name} class="slds-m-bottom_small">
              <h3 slot="title">
                <lightning-icon
                  icon-name="standard:service_contract"
                  size="small"
                  class="slds-m-right_x-small"
                ></lightning-icon>
                {coverage.name}
              </h3>
            </lightning-card>
          </template>

          <!-- Property Coverage with Locations -->
          <template lwc:if={isPropertySelected}>
            <template lwc:if={isLocationBasedPropertyEnabled}>
              <template lwc:if={hasLocations}>
                <lightning-card
                  class="slds-m-bottom_small property-coverage-card"
                >
                  <h3 slot="title">
                    <lightning-icon
                      icon-name="standard:location"
                      size="small"
                      class="slds-m-right_x-small"
                    ></lightning-icon>
                    Property Coverage (by Location)
                  </h3>

                  <!-- Select All Locations -->
                  <div slot="actions" class="slds-m-bottom_medium">
                    <label class="slds-checkbox">
                      <input
                        type="checkbox"
                        checked={propertyLocationSelectAll}
                        onchange={handleLocationSelectAll}
                        aria-label="Select All Locations"
                      />
                      <span class="slds-checkbox_faux"></span>
                      <span class="slds-form-element__label slds-p-left_small">
                        <strong
                          >Select All Locations ({locations.length})</strong
                        >
                      </span>
                    </label>
                  </div>

                  <div class="slds-p-horizontal_medium slds-p-bottom_medium">
                    <!-- Location Search Box -->
                    <div class="slds-m-bottom_medium">
                      <lightning-input
                        type="search"
                        label="Search Locations"
                        placeholder="Type to search..."
                        value={searchLocationTerm}
                        onchange={handleSearchLocationChange}
                      ></lightning-input>
                    </div>

                    <!-- Location Selection Summary -->
                    <div class="slds-m-bottom_medium">
                      <span class="slds-badge slds-badge_inverse">
                        {selectedLocationCount} location(s) selected
                      </span>
                    </div>

                    <!-- Location List -->
                    <div
                      class="coverage-list-container slds-var-p-around_medium"
                    >
                      <template
                        for:each={filteredLocations}
                        for:item="location"
                      >
                        <div
                          key={location.id}
                          class="slds-var-p-around_small slds-var-m-bottom_small location-section"
                        >
                          <div
                            class="slds-grid slds-grid_vertical-align-center location-header"
                          >
                            <div class="slds-col">
                              <lightning-input
                                type="checkbox"
                                label={location.name}
                                data-location-id={location.id}
                                checked={location.isSelected}
                                onchange={handleLocationToggle}
                                class="location-checkbox"
                              ></lightning-input>
                            </div>
                            <div class="slds-col_bump-left">
                              <span class={location.badgeClass}>
                                {location.badgeLabel}
                              </span>
                              <template lwc:if={location.description}>
                                <span
                                  class="slds-text-body_small slds-text-color_weak slds-m-left_small"
                                >
                                  {location.description}
                                </span>
                              </template>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </lightning-card>
              </template>
            </template>
          </template>
        </div>
      </template>
    </template>
  </div>
</template>
